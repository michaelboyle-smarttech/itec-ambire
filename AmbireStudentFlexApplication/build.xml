<?xml version="1.0" encoding="UTF-8" ?>
<project name="AmbireStudentFlexApplication" basedir="." default="Ambire-swf">
	<property name="FLEX_HOME" value="/Developer/SDK/Flex" />
	<taskdef resource="flexTasks.tasks" classpath="${FLEX_HOME}/ant/lib/flexTasks.jar" />
	<uptodate targetfile="Ambire.swf" property="Ambire-swf.uptodate">
		<srcfiles dir=".">
			<include name="Main.mxml" />
			<include name="CameraStatus.as" />
			<include name="Mode.as" />
			<include name="Reason.as" />
			<include name="ambire.jpg" />
			<include name="activity.png" />
			<include name="go.png" />
			<include name="stop.png" />
			<include name="warning.png" />
			<include name="ru/inspirit/net/*.as" />
			<include name="error.mp3" />
			<include name="shutter.mp3" />
		</srcfiles>
	</uptodate>
	<target name="Ambire-swf" depends="AmbireCapture-ane" unless="Ambire-swf.uptodate">
		<mxmlc file="Main.mxml"
			output="Ambire.swf"
			keep-generated-actionscript="true">
			<load-config filename="${FLEX_HOME}/frameworks/air-config.xml" />
			<source-path path-element="${FLEX_HOME}/frameworks" />
			<compiler.debug>true</compiler.debug>
			<compiler.verbose-stacktraces>true</compiler.verbose-stacktraces>
		</mxmlc>
	</target>
	
	
	<condition property="AmbireCapture-nativeLibrary.libraryFile" value="AmbireCapture.dll">
		<os name="Windows" />
	</condition>
	<condition property="AmbireCapture-nativeLibrary.libraryFile" value="AmbireCapture.dylib">
		<os name="Mac OS X" />
	</condition>
	
	<condition property="AmbireCapture-nativeLibrary.uptodate">
		<or>
			<and>
				<os name="Windows" />
				<uptodate targetfile="AmbireCapture.dll">
					<srcfiles dir=".">
						<include name="AmbireCapture-Win32.cpp" />
						<include name="AmbireCapture-Win32.def" />
					</srcfiles>
				</uptodate>
			</and>
			<and>
				<os name="Mac OS X" />
				<uptodate targetfile="AmbireCapture.dylib">
					<srcfiles dir=".">
						<include name="AmbireCapture-MacOSX.mm" />
					</srcfiles>
				</uptodate>
			</and>				
		</or>
	</condition>
	<target name="AmbireCapture-nativeLibrary" unless="AmbireCapture-nativeLibrary.uptodate">
		<echo message="AmbireCapture-nativeLibrary.libraryFile = ${AmbireCapture-nativeLibrary.libraryFile}" />
		<exec executable="cl" os="Windows">
			<arg value="AmbireCapture-Win32.cpp" />
		</exec>
		<exec executable="g++" os="Mac OS X">
			<arg value="-arch" />
			<arg value="i386" />
			<arg value="-fvisibility=hidden" />
			<arg value="-ObjC++" />
			<arg value="-mmacosx-version-min=10.6" />
			<arg value="-framework" />
			<arg value="CoreFoundation" />
			<arg value="-framework" />
			<arg value="ApplicationServices" />
			<arg value="-framework" />
			<arg value="Adobe AIR" />
			<arg value="-dynamiclib" />
			<arg value="-o" />
			<arg value="AmbireCapture.dylib" />
			<arg value="AmbireCapture-MacOSX.mm" />
		</exec>
	</target>
	
	
	<uptodate targetfile="AmbireCapture.swf" property="AmbireCapture-swf.uptodate">
		<srcfiles dir=".">
			<include name="org/eun/itec/ambire/student/AmbireCapture.as" />
		</srcfiles>
	</uptodate>
	<target name="AmbireCapture-swf" unless="AmbireCapture-swf.uptodate">
		<compc output="AmbireCapture.swf" include-classes="org.eun.itec.ambire.student.AmbireCapture" />
		<exec executable="unzip">
			<arg value="-o" />
			<arg value="AmbireCapture.swc" />
			<arg value="library.swf" />
		</exec>
	</target>	
	
	
	<condition property="AmbireCapture-ane.platform" value="Windows-x86">
		<os name="Windows" />
	</condition>
	<condition property="AmbireCapture-ane.platform" value="MacOSX-x86">
		<os name="Mac OS X" />
	</condition>
	<uptodate targetfile="AmbireCapture.ane" property="AmbireCapture-ane.uptodate">
		<srcfiles dir=".">
			<include name="AmbireCapture.xml" />
			<include name="AmbireCapture.swf" />
			<include name="library.swf" />
			<include name="${AmbireCapture-nativeLibrary.libraryFile}" />
		</srcfiles>
	</uptodate>
	<target name="AmbireCapture-ane" depends="AmbireCapture-swf,AmbireCapture-nativeLibrary" unless="AmbireCapture-ane.uptodate">
		<exec executable="cmd" os="Windows">
			<arg value="/c" />
			<arg value="/Developer/SDK/Flex/bin/adt.bat" />
			<arg value="-package" />
			<arg value="-target" />
			<arg value="ane" />
			<arg value="AmbireCapture.ane" />
			<arg value="AmbireCapture.xml" />
			<arg value="-swc" />
			<arg value="AmbireCapture.swc" />
			<arg value="-platform" />
			<arg value="Windows-x86" />
			<arg value="library.swf" />
			<arg value="AmbireCapture.dll" />
		</exec>
		<exec executable="/Developer/SDK/Flex/bin/adt" os="Mac OS X">
			<arg value="-package" />
			<arg value="-target" />
			<arg value="ane" />
			<arg value="AmbireCapture.ane" />
			<arg value="AmbireCapture.xml" />
			<arg value="-swc" />
			<arg value="AmbireCapture.swc" />
			<arg value="-platform" />
			<arg value="MacOSX-x86" />
			<arg value="library.swf" />
			<arg value="AmbireCapture.dylib" />
		</exec>
	</target>
	
	
	<target name="clean">
		<delete dir="generated" />
		<delete>
			<fileset dir=".">
				<include name="Ambire.swf" />
				<include name="AmbireCapture.swc" />
				<include name="AmbireCapture.ane" />
				<include name="library.swf" />
				<include name="AmbireCapture.dll" />
				<include name="AmbireCapture.dylib" />
				<include name="AmbireCapture.exp" />
				<include name="AmbireCapture.lib" />
				<include name="vc100.pdb" />
				<include name="AmbireCapture-Win32.obj" />
				<include name="AmbireCapture-MacOSX.o" />
			</fileset>
		</delete>
	</target>
</project>
